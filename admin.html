<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Jua', sans-serif; background-color: #F0F9FF; }
        .admin-container { background-color: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08); border: 1px solid #E0E7FF; }
        .header-title { color: #1E40AF; }
        .info-box { background-color: #EFF6FF; border-left: 4px solid #3B82F6; }
        .btn-primary { background-color: #2563EB; color: white; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #1D4ED8; }
        .btn-danger { background-color: #DC2626; color: white; transition: background-color 0.3s ease; }
        .btn-danger:hover { background-color: #B91C1C; }
        table { border-collapse: separate; border-spacing: 0; }
        th, td { border-bottom: 1px solid #E5E7EB; }
        th { background-color: #F9FAFB; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="admin-container max-w-4xl mx-auto p-6 sm:p-8">
        <div class="text-center mb-8">
            <h1 class="header-title text-3xl sm:text-4xl font-bold">ğŸ‘‘ ê´€ë¦¬ì í˜ì´ì§€ ğŸ‘‘</h1>
            <p class="text-slate-500 mt-2">ì„¸ì°¨ ê¸°ë¡ CSV íŒŒì¼ ê´€ë¦¬ ë° ì‹¤ì‹œê°„ ì‹ ì²­ í˜„í™©ì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
        </div>

        <div class="mb-10">
            <h2 class="text-xl font-bold text-slate-700 mb-3">1. ì„¸ì°¨ ê¸°ë¡ ê´€ë¦¬</h2>
            <div class="info-box p-4 rounded-lg mb-4">
                <p class="text-sm text-blue-800">
                    <strong class="font-bold">CSV íŒŒì¼ ì–‘ì‹ ì•ˆë‚´:</strong><br>
                    ì²« ë²ˆì§¸ ì¤„ì€ ì œëª© ì¤„ì´ì–´ì•¼ í•©ë‹ˆë‹¤. ë°˜ë“œì‹œ <strong class="text-red-600">'ì´ë¦„'</strong>ê³¼ <strong class="text-red-600">'ì›”'</strong>ì´ í¬í•¨ëœ ì—´ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.<br>
                    (ì˜ˆì‹œ: ì—°ë²ˆ,ì´ë¦„,ë…„ë„,ì›”)
                </p>
            </div>
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <input type="file" id="csvFile" accept=".csv" class="flex-grow w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <button id="uploadBtn" class="btn-primary w-full sm:w-auto rounded-full px-6 py-2.5 font-bold text-sm shadow-lg">ê¸°ë¡ ì—…ë¡œë“œ & ë®ì–´ì“°ê¸°</button>
            </div>
            <div id="status" class="mt-4 text-center"></div>
        </div>

        <div>
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold text-slate-700">2. ì‹¤ì‹œê°„ ì‹ ì²­ í˜„í™©</h2>
                <button id="clearApplicationsBtn" class="btn-danger rounded-full px-5 py-2 text-xs font-bold shadow-md">ì‹ ì²­ ëª©ë¡ ì „ì²´ ì‚­ì œ</button>
            </div>
            <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase">
                        <tr>
                            <th scope="col" class="px-6 py-3">ì‹ ì²­ì¼ì‹œ</th>
                            <th scope="col" class="px-6 py-3">ê³¼ì •</th>
                            <th scope="col" class="px-6 py-3">ì„±í•¨</th>
                            <th scope="col" class="px-6 py-3">ì°¨ì¢…</th>
                            <th scope="col" class="px-6 py-3">ì°¨ëŸ‰ë²ˆí˜¸</th>
                            <th scope="col" class="px-6 py-3">ì„ íƒìš”ì¼</th>
                        </tr>
                    </thead>
                    <tbody id="applicationList">
                        <!-- ì‹ ì²­ ë‚´ì—­ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
                 <div id="noApplications" class="text-center py-10 text-slate-400">
                    ì•„ì§ ì ‘ìˆ˜ëœ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAdoYLtY5BbKh2YSQ3CoFkMKafCY6D87jE",
  authDomain: "saecha-da5c3.firebaseapp.com",
  projectId: "saecha-da5c3",
  storageBucket: "saecha-da5c3.firebasestorage.app",
  messagingSenderId: "770472695100",
  appId: "1:770472695100:web:0573e866b53ffb41967a39"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const fileInput = document.getElementById('csvFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const statusDiv = document.getElementById('status');
        const applicationList = document.getElementById('applicationList');
        const noApplications = document.getElementById('noApplications');
        const clearApplicationsBtn = document.getElementById('clearApplicationsBtn');

        // CSV ì—…ë¡œë“œ ê¸°ëŠ¥
        uploadBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) {
                statusDiv.textContent = 'ë¨¼ì € CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                statusDiv.className = 'mt-4 text-center text-yellow-600';
                return;
            }

            statusDiv.textContent = 'íŒŒì¼ì„ ì½ê³  Firestoreì™€ í†µì‹ í•˜ëŠ” ì¤‘...';
            statusDiv.className = 'mt-4 text-center text-blue-600';

            const reader = new FileReader();
            reader.onload = async (event) => {
                const csvData = event.target.result;
                const lines = csvData.split(/\r\n|\n/);
                const headerLine = lines[0];

                try {
                    const historyCollection = collection(db, "washHistory");
                    
                    const snapshot = await getDocs(historyCollection);
                    const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);

                    const addPromises = [];
                    const header = headerLine.split(',').map(h => h.trim());
                    const nameIndex = header.findIndex(h => h.includes('ì´ë¦„'));
                    const monthIndex = header.findIndex(h => h.includes('ì›”'));

                    if (nameIndex === -1 || monthIndex === -1) {
                        throw new Error("CSV íŒŒì¼ì— 'ì´ë¦„'ê³¼ 'ì›”' ì—´ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.");
                    }

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i];
                        if (line.trim() === '') continue;
                        const values = line.split(',');
                        const name = values[nameIndex] ? values[nameIndex].trim() : '';
                        const month = values[monthIndex] ? parseInt(values[monthIndex].trim(), 10) : NaN;

                        if (name && !isNaN(month)) {
                            const currentYear = new Date().getFullYear();
                            const washDate = new Date(currentYear, month - 1, 15);
                            addPromises.push(addDoc(historyCollection, { name, washDate }));
                        }
                    }
                    await Promise.all(addPromises);
                    statusDiv.textContent = 'âœ… ì„¸ì°¨ ê¸°ë¡ì„ ì„±ê³µì ìœ¼ë¡œ Firestoreì— ì €ì¥í–ˆìŠµë‹ˆë‹¤!';
                    statusDiv.className = 'mt-4 text-center text-green-600 font-bold';

                } catch (error) {
                    console.error("Firestore ì €ì¥ ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ ë°œìƒ:", error);
                    let errorMessage = 'Firestoreì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    if (error.code === 'permission-denied') {
                        errorMessage = 'ğŸš¨ Firestore ì €ì¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤! íŒŒì´ì–´ë² ì´ìŠ¤ "ê·œì¹™" íƒ­ì´ "allow read, write: if true;"ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”!';
                    } else if (error.message.includes('ì—´ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤')) {
                        errorMessage = 'ğŸš¨ ì—…ë¡œë“œí•œ CSV íŒŒì¼ì— "ì´ë¦„" ë˜ëŠ” "ì›”" ì—´ì´ ë¹ ì ¸ìˆìŠµë‹ˆë‹¤. íŒŒì¼ ì–‘ì‹ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”!';
                    } else {
                        errorMessage += `<br><span class="text-xs">ìƒì„¸ ì˜¤ë¥˜(ê°œë°œììš©): ${error.message}</span>`;
                    }
                    statusDiv.innerHTML = errorMessage;
                    statusDiv.className = 'mt-4 text-center text-red-600 leading-relaxed font-bold';
                }
            };
            reader.readAsText(file, 'EUC-KR');
        });

        // ì‹¤ì‹œê°„ ì‹ ì²­ í˜„í™© ë¦¬ìŠ¤ë„ˆ
        const q = query(collection(db, "applications"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            applicationList.innerHTML = '';
            if (snapshot.empty) {
                noApplications.style.display = 'block';
            } else {
                noApplications.style.display = 'none';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const tr = document.createElement('tr');
                    tr.className = "bg-white border-b hover:bg-gray-50";
                    const timestamp = data.timestamp?.toDate ? data.timestamp.toDate().toLocaleString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ';
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${timestamp}</td>
                        <td class="px-6 py-4">${data.course || ''}</td>
                        <td class="px-6 py-4">${data.name || ''}</td>
                        <td class="px-6 py-4">${data.carType || ''}</td>
                        <td class="px-6 py-4">${data.carNumber || ''}</td>
                        <td class="px-6 py-4">${(data.selectedDays || []).join(', ')}</td>
                    `;
                    applicationList.appendChild(tr);
                });
            }
        });

        // ì‹ ì²­ ëª©ë¡ ì‚­ì œ ê¸°ëŠ¥
        clearApplicationsBtn.addEventListener('click', async () => {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ì‹ ì²­ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                try {
                    const appCollection = collection(db, "applications");
                    const snapshot = await getDocs(appCollection);
                    const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    alert('ëª¨ë“  ì‹ ì²­ ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error("ì‹ ì²­ ë‚´ì—­ ì‚­ì œ ì˜¤ë¥˜:", error);
                    alert('ì‹ ì²­ ë‚´ì—­ì„ ì‚­ì œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        });
    </script>
</body>
</html>

