<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Jua', sans-serif; background-color: #f8fafc; }
        .admin-container { background-color: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08); }
        .header-title { color: #1e293b; }
        .section-box { border: 1px solid #e2e8f0; border-radius: 16px; }
        .upload-area { border: 2px dashed #cbd5e1; border-radius: 12px; transition: all 0.3s; }
        .upload-area.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        .status-table th { background-color: #f1f5f9; color: #475569; }
        .status-table td { border-bottom: 1px solid #e2e8f0; }
        .btn { border-radius: 12px; transition: all 0.2s ease-in-out; }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .info-box { background-color: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
        .error-message { color: #dc2626; font-weight: bold; }
        .month-header { cursor: pointer; transition: background-color 0.2s; }
        .month-header:hover { background-color: #f1f5f9; }
        .month-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="admin-container max-w-5xl mx-auto p-6 sm:p-10">
        <header class="text-center mb-10">
            <h1 class="header-title text-3xl sm:text-4xl font-bold">ğŸ‘‘ ìŠ¤íŒ€ ì„¸ì°¨ ê´€ë¦¬ì í˜ì´ì§€ ğŸ‘‘</h1>
        </header>

        <main class="space-y-10">
            <!-- CSV Upload Section -->
            <section class="section-box p-6">
                <h2 class="text-2xl font-semibold text-slate-800 mb-4">ì„¸ì°¨ ê¸°ë¡ ê´€ë¦¬</h2>
                <div class="info-box p-4 rounded-lg mb-6">
                    <p class="font-bold">âœ… CSV íŒŒì¼ ì–‘ì‹ ì•ˆë‚´</p>
                    <p class="text-sm mt-1">'ì—°ë²ˆ, ì´ë¦„, ë…„ë„, ì›”' ìˆœì„œë¡œ CSV íŒŒì¼ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. (ì˜ˆ: 1, í™ê¸¸ë™, 2025, 9)</p>
                </div>
                <div id="uploadArea" class="upload-area p-8 text-center cursor-pointer">
                    <p class="text-slate-500">ì—¬ê¸°ì— CSV íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜<br>í´ë¦­í•´ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                    <input type="file" id="csvFileInput" class="hidden" accept=".csv">
                </div>
                <p id="selectedFileName" class="text-center mt-2 text-slate-600 font-semibold"></p>
                <button id="processUploadBtn" class="btn btn-primary w-full py-2 mt-4" disabled>
                    ê¸°ë¡ ì—…ë¡œë“œ<br>&amp; ë®ì–´ì“°ê¸°
                </button>
                <p id="uploadStatus" class="mt-4 text-center font-semibold"></p>
                <p id="errorMessage" class="error-message text-center mt-2"></p>
            </section>

            <!-- Application List Section -->
            <section class="section-box p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                    <h2 class="text-2xl font-semibold text-slate-800">ì‹¤ì‹œê°„ ì‹ ì²­ í˜„í™©</h2>
                    <div class="flex-shrink-0">
                        <button id="deleteSelectedBtn" class="btn btn-primary px-4 py-2 text-sm mr-2">ì„ íƒ ì‚­ì œ</button>
                        <button id="clearApplicationsBtn" class="btn btn-danger px-4 py-2 text-sm">ëª©ë¡ ì „ì²´ ì§€ìš°ê¸°</button>
                    </div>
                </div>
                <div id="monthlyApplicationsContainer" class="space-y-2">
                    <!-- Monthly data will be populated here -->
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, query, writeBatch, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAdoYLtY5BbKh2YSQ3CoFkMKafCY6D87jE",
          authDomain: "saecha-da5c3.firebaseapp.com",
          projectId: "saecha-da5c3",
          storageBucket: "saecha-da5c3.appspot.com",
          messagingSenderId: "770472695100",
          appId: "1:770472695100:web:0573e866b53ffb41967a39"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const uploadArea = document.getElementById('uploadArea');
        const csvFileInput = document.getElementById('csvFileInput');
        const uploadStatus = document.getElementById('uploadStatus');
        const errorMessage = document.getElementById('errorMessage');
        const selectedFileName = document.getElementById('selectedFileName');
        const processUploadBtn = document.getElementById('processUploadBtn');
        let selectedFile = null;

        const monthlyApplicationsContainer = document.getElementById('monthlyApplicationsContainer');
        const clearApplicationsBtn = document.getElementById('clearApplicationsBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

        // --- CSV ì—…ë¡œë“œ ë¡œì§ ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, preventDefaults, false));
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false));
        ['dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false));
        uploadArea.addEventListener('drop', handleDrop, false);
        uploadArea.addEventListener('click', () => csvFileInput.click());
        csvFileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        processUploadBtn.addEventListener('click', () => {
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = (e) => processCSV(e.target.result);
                reader.readAsText(selectedFile);
            }
        });
        function handleDrop(e) { handleFiles(e.dataTransfer.files); }
        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                    displayError('CSV íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    selectedFile = null; selectedFileName.textContent = ''; processUploadBtn.disabled = true; return;
                }
                selectedFile = file; selectedFileName.textContent = `ì„ íƒëœ íŒŒì¼: ${file.name}`; processUploadBtn.disabled = false; clearMessages();
            }
        }
        async function processCSV(csvText) {
            clearMessages(); uploadStatus.textContent = 'CSV íŒŒì¼ ì²˜ë¦¬ ì¤‘...'; processUploadBtn.disabled = true;
            
            let content = csvText;
            if (content.charCodeAt(0) === 0xFEFF) {
                content = content.slice(1);
            }

            const lines = content.split(/\r\n|\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) { displayError("CSV íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ (í—¤ë” ì œì™¸)."); processUploadBtn.disabled = selectedFile ? false : true; return; }
            
            const header = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const nameIndex = header.indexOf('ì´ë¦„'); const monthIndex = header.indexOf('ì›”'); const yearIndex = header.indexOf('ë…„ë„');

            if (nameIndex === -1 || monthIndex === -1) { 
                // âœ¨ ì´ˆì •ë°€ ë¶„ì„ ì¥ë¹„ íƒ‘ì¬! âœ¨
                const errorDetail = `[ê°ì§€ëœ í—¤ë”: ${JSON.stringify(header)}]`;
                displayError(`CSV íŒŒì¼ í—¤ë”ì— 'ì´ë¦„'ê³¼ 'ì›”'ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ${errorDetail}`);
                processUploadBtn.disabled = selectedFile ? false : true; 
                return; 
            }
            try {
                const batch = writeBatch(db);
                const historySnapshot = await getDocs(collection(db, "washHistory"));
                historySnapshot.forEach(doc => batch.delete(doc.ref));
                for (let i = 1; i < lines.length; i++) {
                    const data = lines[i].split(',');
                    const name = data[nameIndex]?.trim().replace(/"/g, '');
                    const month = parseInt(data[monthIndex]?.trim().replace(/"/g, ''), 10);
                    const year = yearIndex !== -1 ? parseInt(data[yearIndex]?.trim().replace(/"/g, ''), 10) : new Date().getFullYear();
                    if (name && !isNaN(month) && !isNaN(year)) {
                        const date = new Date(year, month - 1, 1);
                        batch.set(doc(db, "washHistory", name), { name, date });
                    }
                }
                await batch.commit();
                uploadStatus.textContent = `âœ… ${lines.length - 1}ê°œì˜ ì„¸ì°¨ ê¸°ë¡ì„ ì„±ê³µì ìœ¼ë¡œ ë®ì–´ì¼ìŠµë‹ˆë‹¤!`;
            } catch (error) {
                console.error("Firestore ì €ì¥ ì˜¤ë¥˜:", error);
                if (error.code === 'permission-denied') { displayError('ğŸš¨ Firestore ì €ì¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤! íŒŒì´ì–´ë² ì´ìŠ¤ "ê·œì¹™" íƒ­ì´ "allow read, write: if true;"ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”!'); } 
                else { displayError(`Firestoreì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); }
            } finally { processUploadBtn.disabled = selectedFile ? false : true; }
        }
        
        // --- ì‹¤ì‹œê°„ ì‹ ì²­ í˜„í™© (ì›”ë³„ ê·¸ë£¹í•‘) ---
        const q = query(collection(db, "applications"));
        onSnapshot(q, (querySnapshot) => {
            const groupedByMonth = {};
            querySnapshot.forEach((doc) => {
                const app = doc.data();
                if (app.timestamp && app.timestamp.toDate) {
                    const date = app.timestamp.toDate();
                    const monthKey = `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›”`;
                    if (!groupedByMonth[monthKey]) {
                        groupedByMonth[monthKey] = [];
                    }
                    groupedByMonth[monthKey].push({ id: doc.id, ...app });
                }
            });

            monthlyApplicationsContainer.innerHTML = '';
            const sortedMonths = Object.keys(groupedByMonth).sort((a, b) => new Date(b.replace('ë…„ ', '-').replace('ì›”', '')) - new Date(a.replace('ë…„ ', '-').replace('ì›”', '')));

            if (sortedMonths.length === 0) {
                monthlyApplicationsContainer.innerHTML = '<p class="text-center text-slate-500 py-4">ì•„ì§ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            sortedMonths.forEach(monthKey => {
                const applications = groupedByMonth[monthKey];
                const monthContainer = document.createElement('div');
                monthContainer.className = 'border border-slate-200 rounded-lg';
                
                const header = document.createElement('button');
                header.className = 'month-header w-full text-left p-4 font-semibold text-lg text-slate-700 flex justify-between items-center';
                header.innerHTML = `<span>${monthKey} (${applications.length}ê±´)</span><span>â–¼</span>`;
                
                const content = document.createElement('div');
                content.className = 'month-content';

                const tableHTML = `
                    <div class="overflow-x-auto">
                        <table class="status-table w-full text-left">
                            <thead>
                                <tr>
                                    <th class="p-3"><input type="checkbox" class="select-month-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"></th>
                                    <th class="p-3">ì‹ ì²­ì‹œê°„</th>
                                    <th class="p-3">ê³¼ì •</th>
                                    <th class="p-3">ì„±í•¨</th>
                                    <th class="p-3">ì°¨ì¢…</th>
                                    <th class="p-3">ì°¨ëŸ‰ë²ˆí˜¸</th>
                                    <th class="p-3">ì‹ ì²­ìš”ì¼</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${applications.map(app => {
                                    const timestamp = app.timestamp?.toDate()?.toLocaleString('ko-KR') || 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
                                    const days = Array.isArray(app.selectedDays) ? app.selectedDays.join(', ') : 'ìš”ì¼ ì •ë³´ ì—†ìŒ';
                                    return `
                                        <tr>
                                            <td class="p-3"><input type="checkbox" class="row-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" data-doc-id="${app.id}"></td>
                                            <td class="p-3 text-sm">${timestamp}</td>
                                            <td class="p-3">${app.course || ''}</td>
                                            <td class="p-3">${app.name || ''}</td>
                                            <td class="p-3">${app.carType || ''}</td>
                                            <td class="p-3">${app.carNumber || ''}</td>
                                            <td class="p-3 text-sm">${days}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                content.innerHTML = tableHTML;
                monthContainer.appendChild(header);
                monthContainer.appendChild(content);
                monthlyApplicationsContainer.appendChild(monthContainer);

                header.addEventListener('click', () => {
                    const isOpened = content.style.maxHeight;
                    if (isOpened && isOpened !== '0px') {
                        content.style.maxHeight = '0px';
                        header.querySelector('span:last-child').textContent = 'â–¼';
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                        header.querySelector('span:last-child').textContent = 'â–²';
                    }
                });
                
                content.querySelector('.select-month-checkbox').addEventListener('click', (e) => {
                    content.querySelectorAll('.row-checkbox').forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });
            });

        }, (error) => {
            console.error("Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
            let detailedMessage = `ğŸš¨ ì‹ ì²­ í˜„í™© ë¡œë”© ì‹¤íŒ¨ (${error.code}). ì¸í„°ë„· ì—°ê²° ë˜ëŠ” íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”!`;
            if (error.code === 'unavailable') { detailedMessage = 'ğŸš¨ Firestore ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì´ ë¶ˆì•ˆì •í•˜ê±°ë‚˜, HTMLì— ì…ë ¥í•œ "ë¹„ë°€ ì—´ì‡ (firebaseConfig)"ê°€ ì •í™•í•œì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”!'; }
            else if (error.code === 'permission-denied') { detailedMessage = 'ğŸš¨ Firestore ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤! íŒŒì´ì–´ë² ì´ìŠ¤ "ê·œì¹™" íƒ­ì´ "allow read, write: if true;"ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”!'; }
            displayError(detailedMessage);
        });

        deleteSelectedBtn.addEventListener('click', async () => {
            const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            if (selectedCheckboxes.length === 0) { alert('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            if (confirm(`ì„ íƒëœ ${selectedCheckboxes.length}ê°œì˜ í•­ëª©ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                try {
                    const batch = writeBatch(db);
                    selectedCheckboxes.forEach(checkbox => {
                        batch.delete(doc(db, "applications", checkbox.dataset.docId));
                    });
                    await batch.commit();
                    alert(`${selectedCheckboxes.length}ê°œì˜ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } catch (error) { console.error("ì„ íƒ ì‚­ì œ ì˜¤ë¥˜:", error); alert(`ì„ íƒ í•­ëª©ì„ ì‚­ì œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); }
            }
        });

        clearApplicationsBtn.addEventListener('click', async () => {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ì‹ ì²­ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                try {
                    const querySnapshot = await getDocs(collection(db, "applications"));
                    const batch = writeBatch(db);
                    querySnapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    alert('ëª¨ë“  ì‹ ì²­ ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) { console.error("ì‚­ì œ ì˜¤ë¥˜:", error); alert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); }
            }
        });

        function displayError(msg) { errorMessage.textContent = msg; uploadStatus.textContent = ''; }
        function clearMessages() { uploadStatus.textContent = ''; errorMessage.textContent = ''; }
    </script>
</body>
</html>

